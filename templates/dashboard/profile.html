{% extends 'dashboard/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Profile - Glance 2.0{% endblock %}

{% block page_title %}Profile Settings{% endblock %}

{% block content %}
<div class="row">
    <!-- Profile Overview -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-body text-center">
                <div class="profile-picture mb-3">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" 
                             alt="Profile Picture" 
                             class="rounded-circle mb-3"
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <img src="{% static 'img/dashboard/default-avatar.png' %}" 
                             alt="Profile Picture" 
                             class="rounded-circle mb-3"
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% endif %}
                    <div class="mt-2">
                        <label for="profile-picture" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-camera"></i> Change Picture
                        </label>
                        <input type="file" 
                               id="profile-picture" 
                               name="profile_picture" 
                               accept="image/*" 
                               class="d-none"
                               data-preview="profile-picture-preview">
                    </div>
                </div>
                <h4>{{ user.get_full_name|default:user.email }}</h4>
                <p class="text-muted">{{ user.email }}</p>
                
                <!-- Profile Status -->
                <div class="profile-status mb-3">
                    <div class="progress mb-2">
                        <div class="progress-bar profile-progress" 
                             role="progressbar" 
                             style="width: {{ profile_completion }}%"
                             aria-valuenow="{{ profile_completion }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ profile_completion }}%
                        </div>
                    </div>
                    <small class="text-muted">Profile Completion</small>
                </div>

                <!-- Status Badges -->
                <div class="status-badges mb-3">
                    {% if user.is_placed %}
                        <span class="status-badge success">Placed</span>
                    {% endif %}
                    {% if user.is_shortlisted %}
                        <span class="status-badge warning">Shortlisted</span>
                    {% endif %}
                    {% if user.is_btech %}
                        <span class="status-badge info">Repositol</span>
                    {% else %}
                        <span class="status-badge secondary">Non-Rep</span>
                    {% endif %}
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#resumeModal">
                        <i class="fas fa-file-alt"></i> Upload Resume
                    </button>
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#certificatesModal">
                        <i class="fas fa-certificate"></i> Add Certificates
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Details -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" data-validate>
                    {% csrf_token %}
                    
                    <!-- Personal Information -->
                    <h6 class="mb-3">Personal Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="full_name" 
                                   value="{{ user.get_full_name }}"
                                   required
                                   data-required="true">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                            <input type="tel" 
                                   class="form-control" 
                                   name="phone" 
                                   value="{{ user.phone }}"
                                   required
                                   data-required="true">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gender <span class="text-danger">*</span></label>
                            <select class="form-select" name="gender" required data-required="true">
                                <option value="">Select Gender</option>
                                <option value="M" {% if user.gender == 'M' %}selected{% endif %}>Male</option>
                                <option value="F" {% if user.gender == 'F' %}selected{% endif %}>Female</option>
                                <option value="O" {% if user.gender == 'O' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Academic Information -->
                    <h6 class="mb-3 mt-4">Academic Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">College/University <span class="text-danger">*</span></label>
                            <input type="text" 
                                   class="form-control" 
                                   name="college" 
                                   value="{{ user.college }}"
                                   required
                                   data-required="true">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Current Year <span class="text-danger">*</span></label>
                            <select class="form-select" name="current_year" required data-required="true">
                                <option value="">Select Year</option>
                                <option value="1" {% if user.current_year == 1 %}selected{% endif %}>1st Year</option>
                                <option value="2" {% if user.current_year == 2 %}selected{% endif %}>2nd Year</option>
                                <option value="3" {% if user.current_year == 3 %}selected{% endif %}>3rd Year</option>
                                <option value="4" {% if user.current_year == 4 %}selected{% endif %}>4th Year</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Course <span class="text-danger">*</span></label>
                            <select class="form-select" name="course" required data-required="true">
                                <option value="">Select Course</option>
                                <option value="BTECH" {% if user.course == 'BTECH' %}selected{% endif %}>B.Tech</option>
                                <option value="MTECH" {% if user.course == 'MTECH' %}selected{% endif %}>M.Tech</option>
                                <option value="BCA" {% if user.course == 'BCA' %}selected{% endif %}>BCA</option>
                                <option value="MCA" {% if user.course == 'MCA' %}selected{% endif %}>MCA</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Specialization</label>
                            <input type="text" 
                                   class="form-control" 
                                   name="specialization" 
                                   value="{{ user.specialization }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">CPI/CGPA <span class="text-danger">*</span></label>
                            <input type="number" 
                                   class="form-control" 
                                   name="cgpa" 
                                   value="{{ user.cgpa }}"
                                   step="0.01"
                                   min="0"
                                   max="10"
                                   required
                                   data-required="true">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Backlogs</label>
                            <div class="row">
                                <div class="col-6">
                                    <input type="number" 
                                           class="form-control" 
                                           name="total_backlogs" 
                                           value="{{ user.total_backlogs }}"
                                           min="0"
                                           placeholder="Total">
                                </div>
                                <div class="col-6">
                                    <input type="number" 
                                           class="form-control" 
                                           name="current_backlogs" 
                                           value="{{ user.current_backlogs }}"
                                           min="0"
                                           placeholder="Current Year">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Links -->
                    <h6 class="mb-3 mt-4">Professional Links</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">GitHub Profile</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fab fa-github"></i></span>
                                <input type="url" 
                                       class="form-control" 
                                       name="github_profile" 
                                       value="{{ user.github_profile }}"
                                       placeholder="https://github.com/username">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">LinkedIn Profile</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fab fa-linkedin"></i></span>
                                <input type="url" 
                                       class="form-control" 
                                       name="linkedin_profile" 
                                       value="{{ user.linkedin_profile }}"
                                       placeholder="https://linkedin.com/in/username">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <h6 class="mb-3 mt-4">Additional Information</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">High School Information</label>
                            <textarea class="form-control" 
                                      name="high_school_info" 
                                      rows="3">{{ user.high_school_info }}</textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Internship Details</label>
                            <textarea class="form-control" 
                                      name="internship_details" 
                                      rows="3">{{ user.internship_details }}</textarea>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Theme Preferences</h5>
            </div>
            <div class="card-body">
                <form method="post" class="theme-preference-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="theme_preference">Choose Theme</label>
                        <select name="theme_preference" id="theme_preference" class="form-select">
                            <option value="light" {% if user.theme_preference == 'light' %}selected{% endif %}>Light Mode</option>
                            <option value="dark" {% if user.theme_preference == 'dark' %}selected{% endif %}>Dark Mode</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Save Theme Preference</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Resume Upload Modal -->
<div class="modal fade" id="resumeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Resume</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'upload_resume' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Resume (PDF)</label>
                        <input type="file" 
                               class="form-control" 
                               name="resume" 
                               accept=".pdf"
                               required>
                        <div class="form-text">Maximum file size: 5MB</div>
                    </div>
                    <div class="mb-3">
                        <div class="ats-score">
                            <h6>ATS Score</h6>
                            <div class="progress">
                                <div class="progress-bar" 
                                     role="progressbar" 
                                     style="width: {{ ats_score }}%"
                                     aria-valuenow="{{ ats_score }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ ats_score }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Resume
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Certificates Modal -->
<div class="modal fade" id="certificatesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Certificates</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" enctype="multipart/form-data" action="{% url 'add_certificate' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Certificate Name</label>
                        <input type="text" class="form-control" name="certificate_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issuing Organization</label>
                        <input type="text" class="form-control" name="issuing_organization" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issue Date</label>
                        <input type="date" class="form-control" name="issue_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Certificate File</label>
                        <input type="file" 
                               class="form-control" 
                               name="certificate_file" 
                               accept=".pdf,.jpg,.jpeg,.png"
                               required>
                        <div class="form-text">Maximum file size: 5MB</div>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add Certificate
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // File upload preview
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.querySelector(`#${this.dataset.preview}`);
                    if (preview) {
                        if (file.type.startsWith('image/')) {
                            preview.src = e.target.result;
                        } else {
                            preview.textContent = file.name;
                        }
                    }
                }.bind(this);
                reader.readAsDataURL(file);
            }
        });
    });
</script>
{% endblock %} 